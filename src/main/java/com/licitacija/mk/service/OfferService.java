package com.licitacija.mk.service;import com.licitacija.mk.models.Offer;import com.licitacija.mk.models.Product;import com.licitacija.mk.models.User;import com.licitacija.mk.models.exceptions.BadParametarException;import com.licitacija.mk.models.exceptions.NotFoundException;import com.licitacija.mk.repository.OfferRepository;import org.springframework.stereotype.Service;import java.time.LocalDateTime;import java.util.Comparator;import java.util.List;@Servicepublic class OfferService {    private final OfferRepository repository;    private final UserService userService;    private final ProductService productService;    public OfferService(OfferRepository repository, UserService userService, ProductService productService) {        this.repository = repository;        this.userService = userService;        this.productService = productService;    }    public Offer findOfferById(Long id) {        return repository.findById(id).orElseThrow(() -> new NotFoundException("There is no offer with id:" + id));    }    public void addNewOffer(String user_idString, String product_idString, String priceString) {        Long user_id,product_id,price;        try {            user_id = Long.parseLong(user_idString);        } catch (Exception e) {            throw new BadParametarException("User Id is not ok!");        }        User user = userService.findUserById(user_id);        try {            product_id = Long.parseLong(product_idString);        } catch (Exception e) {            throw new BadParametarException("Product id  is not ok!");        }        Product product = productService.findProductById(product_id);        try {            price = Long.parseLong(priceString);        } catch (Exception e) {            throw new BadParametarException("Price in offer is not ok");        }        if (price < product.getMax_price()) {            throw new BadParametarException("The price is lower than max price");        }//        if(price>product.getMax_price()){//            //TODO UPDATE PRODUCT MAXPRICE//        }        LocalDateTime date = LocalDateTime.now();        Offer offer = new Offer();        offer.setDate(date);        offer.setGivenByUser(user);        offer.setGivenForProduct(product);        offer.setPrice(price);        repository.save(offer);    }    public List<Offer> findAllOffersForProduct(String product_idString) {        Long product_id;        try {            product_id = Long.parseLong(product_idString);        } catch (Exception e) {            throw new BadParametarException("Product id  is not ok!");        }        Product product = productService.findProductById(product_id);        return repository.findAllByGivenForProduct(product);    }    public List<Offer> findAllOffersFromUser(String user_idString) {        Long user_id;        try {            user_id = Long.parseLong(user_idString);        } catch (Exception e) {            throw new BadParametarException("User Id is not ok!");        }        User user = userService.findUserById(user_id);        return repository.findAllByGivenByUser(user);    }    public Offer findLatestOfferByUser(String user_idString) {        Long user_id;        try {            user_id = Long.parseLong(user_idString);        } catch (Exception e) {            throw new BadParametarException("User Id is not ok!");        }        List<Offer> rez = findAllOffersFromUser(user_idString);        return rez.stream()                .max(Comparator.comparing(Offer::getDate))                .orElseThrow(() -> new NotFoundException("No offers from :" + user_id));    }}